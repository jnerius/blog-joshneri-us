+++ 
date = 2016-06-22T17:02:35-05:00
title = "Saving RESTMessageV2 Responses as Attachments in ServiceNow"
description = ""
slug = "saving-restmessagev2-responses-as-attachments-in-servicenow" 
tags = ["ServiceNow"]
categories = []
externalLink = ""
series = []
+++

**Applies to**: Geneva, Helsinki and beyond. 

Have you ever needed to: 

1. Retrieve something using RESTMessageV2
2. Save that thing as an attachment on a record
3. Do something with the newly generated attachment? 

This recently came up as a question over in the [sndevs slack channel](http://bit.ly/28NbZdE), and I realized that I knew how to accomplish #1 and #2, but didn't know how to actually identify the attachment to achieve #3 without some ugly hacks. But as it turns out, there's a **right** way to do this. 

#### First, some code

Here's a quick refresher on steps 1 and 2: retrieving and saving an attachment. 

```javascript
// This is where we'll save the attachment
var tablename   = 'incident';
var recordSysId = '8d6353eac0a8016400d8a125ca14fc1f';
var filename    = 'snlogo.png';

// Let's download the ServiceNow Logo
var logoUrl = 'https://instance.service-now.com/images/logos/logo_service-now.png';
var request = new sn_ws.RESTMessageV2();
request.setHttpMethod('get');
request.setEndpoint(logoUrl);

// Configure the request to save the response as an attachment
request.saveResponseBodyAsAttachment(tablename, recordSysId, filename);

// When we execute the request, the attachment will automatically be
// saved to the record we specified
var response = request.execute();
var httpResponseStatus = response.getStatusCode();
var httpResponseContentType = response.getHeader('Content-Type');
gs.debug("http response status_code: " + httpResponseStatus);
gs.debug("http response content-type: " + httpResponseContentType);
```


#### Now what? 

If all you're concerned about is saving the attachment data to a record, you're done. No further actions are necessary. But what if you want to do something **else** with the attachment you just generated? Copy it somewhere, process its contents, etc? 

The call to [`saveResponseBodyAsAttachment()`](http://bit.ly/28Naj3D) returns void, so we can't get a reference to the attachment from there. We could do something super ugly like go query the sys_attachment table and find the latest attachment associated with our target record, but this is far from ideal and prone to bugs. 

I was happy to learn that there's a  **correct** way to do this. 


#### Using getResponseAttachmentSysid()

The [`response`](http://bit.ly/28OCHYt) object returned by [`request.execute()`](http://bit.ly/28Naj3D) provides a method called [`getResponseAttachmentSysid()`](http://bit.ly/28PmalB). As the method name suggests, this returns the sys_id of the attachment generated by the REST call. 

To use this, we simply call the method after executing the request. We can append the following lines of code to the earlier example: 

```javascript
// Get the sys_id of the newly created attachment
var newAttachmentSysId = response.getResponseAttachmentSysid();

// Do something useful with it
var grAttach = new GlideRecord('sys_attachment');
if (grAttach.get(newAttachmentSysId)) {
  // Note: we're using the scoped version of GlideSysAttachment 
  // for this example. 
  var gsa = new GlideSysAttachment()
  var content = gsa.getContent(grAttach); 
  // Now we have the data...the rest is up to you
}
```

You can view/download the complete script [here](https://gist.github.com/jnerius/d2f28b845a64fa7e1d296c79f877a8c2). This can be executed from **Scripts - Background**, just remember to update the instance URL and target table/record. 

Happy attaching! 

[View and discuss this article on the ServiceNow Community](https://community.servicenow.com/community?id=community_blog&sys_id=05fda22ddbd0dbc01dcaf3231f9619c8). 